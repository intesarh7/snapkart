generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model User {
  id                 Int               @id @default(autoincrement())
  name               String
  email              String            @unique
  phone              String            @unique
  password           String
  image              String?
  isAvailable        Boolean           @default(true)
  maxActiveOrders    Int               @default(1)
  minActiveOrders    Int               @default(0)
  commissionType     String?
  commissionValue    Float?
  role               Role              @default(USER)
  isActive           Boolean           @default(true)
  otp                String?
  otpExpiry          DateTime?
  latitude           Float?
  longitude          Float?
  lastLocationUpdate DateTime?
  createdAt          DateTime          @default(now())
  updatedAt          DateTime          @updatedAt
  addresses          Address[]
  couponUsages       CouponUsage[]
  deliveryEarnings   DeliveryEarning[] @relation("UserDeliveryEarnings")
  deliveryOrders     Order[]           @relation("DeliveryBoyOrders")
  orders             Order[]           @relation("CustomerOrders")
  payments           Payment[]
  bookings           TableBooking[]
}

model Restaurant {
  id             Int                       @id @default(autoincrement())
  name           String
  address        String
  city           String                    @default("Unknown")
  latitude       Float
  longitude      Float
  image          String?
  openTime       String?
  closeTime      String?
  rating         Float?                    @default(0)
  deliveryTime   String?
  addOffer       String?
  isActive       Boolean                   @default(true)
  isOpen         Boolean                   @default(true)
  createdAt      DateTime                  @default(now())
  updatedAt      DateTime                  @updatedAt
  categories     Category[]
  deliveryRules  DeliveryRule[]
  orders         Order[]
  products       Product[]
  bookingSetting RestaurantBookingSetting?
  tables         RestaurantTable[]
  bookings       TableBooking[]
}

model RestaurantBookingSetting {
  id               Int          @id @default(autoincrement())
  restaurantId     Int          @unique
  isBookingEnabled Boolean      @default(false)
  advanceRequired  Boolean      @default(false)
  advanceType      AdvanceType?
  advanceValue     Float?
  createdAt        DateTime     @default(now())
  updatedAt        DateTime     @updatedAt
  restaurant       Restaurant   @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
}

model TableBooking {
  id                   Int                   @id @default(autoincrement())
  restaurantId         Int
  tableId              Int?
  userId               Int
  bookingDate          DateTime
  bookingTime          String
  guests               Int
  location             TableLocation?
  specialNote          String?
  status               BookingStatus         @default(PENDING)
  advanceAmount        Float?
  isAdvancePaid        Boolean               @default(false)
  createdAt            DateTime              @default(now())
  updatedAt            DateTime              @updatedAt
  bookingNotifications BookingNotification[]
  preOrderedProducts   BookingProduct[]
  restaurant           Restaurant            @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  table                RestaurantTable?      @relation(fields: [tableId], references: [id])
  user                 User                  @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([restaurantId], map: "TableBooking_restaurantId_fkey")
  @@index([tableId], map: "TableBooking_tableId_fkey")
  @@index([userId], map: "TableBooking_userId_fkey")
}

model BookingNotification {
  id        Int          @id @default(autoincrement())
  bookingId Int
  isRead    Boolean      @default(false)
  createdAt DateTime     @default(now())
  booking   TableBooking @relation(fields: [bookingId], references: [id], onDelete: Cascade)

  @@index([bookingId], map: "BookingNotification_bookingId_fkey")
}

model RestaurantTable {
  id           Int            @id @default(autoincrement())
  restaurantId Int
  tableNumber  String
  capacity     Int
  location     TableLocation
  isActive     Boolean        @default(true)
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt
  restaurant   Restaurant     @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  bookings     TableBooking[]

  @@index([restaurantId], map: "RestaurantTable_restaurantId_fkey")
}

model BookingProduct {
  id        Int          @id @default(autoincrement())
  bookingId Int
  productId Int
  quantity  Int
  createdAt DateTime     @default(now())
  booking   TableBooking @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  product   Product      @relation(fields: [productId], references: [id])

  @@index([bookingId], map: "BookingProduct_bookingId_fkey")
  @@index([productId], map: "BookingProduct_productId_fkey")
}

model Product {
  id              Int              @id @default(autoincrement())
  name            String
  description     String
  image           String?
  category        String
  categoryId      Int?
  isAvailable     Boolean          @default(true)
  isActive        Boolean          @default(true)
  price           Float
  offerType       String?
  offerValue      Float?
  extraType       String?
  extraValue      Float?
  finalPrice      Float
  rating          Float            @default(0)
  restaurantId    Int
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  slug            String?          @unique(map: "slug")
  bookingProducts BookingProduct[]
  orderItems      OrderItem[]
  categoryRef     Category?        @relation(fields: [categoryId], references: [id])
  restaurant      Restaurant       @relation(fields: [restaurantId], references: [id])
  extras          ProductExtra[]
  variants        ProductVariant[]

  @@index([restaurantId])
  @@index([categoryId])
}

model Category {
  id           Int        @id @default(autoincrement())
  name         String
  image        String?
  restaurantId Int
  active       Boolean    @default(true)
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
  restaurant   Restaurant @relation(fields: [restaurantId], references: [id])
  products     Product[]

  @@index([restaurantId], map: "Category_restaurantId_fkey")
}

model Offer {
  id          Int       @id @default(autoincrement())
  title       String
  description String?
  type        OfferType
  value       Float
  isPopup     Boolean   @default(false)
  isMarquee   Boolean   @default(false)
  isActive    Boolean   @default(true)
  expiresAt   DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
}

model Coupon {
  id             Int           @id @default(autoincrement())
  title          String
  description    String?
  code           String        @unique
  type           CouponType
  value          Float
  isActive       Boolean       @default(true)
  expiresAt      DateTime?
  usageLimit     Int?
  usedCount      Int           @default(0)
  oneTimePerUser Boolean       @default(false)
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
  usages         CouponUsage[]
  orders         Order[]
}

model CouponUsage {
  id        Int      @id @default(autoincrement())
  couponId  Int
  userId    Int
  createdAt DateTime @default(now())
  coupon    Coupon   @relation(fields: [couponId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([couponId, userId])
  @@index([userId], map: "CouponUsage_userId_fkey")
}

model DeliveryRule {
  id           Int        @id @default(autoincrement())
  title        String
  restaurantId Int
  minOrder     Float
  maxOrder     Float?
  minDistance  Float
  maxDistance  Float?
  chargeType   ChargeType
  chargeAmount Float
  baseDistance Float?
  perKmCharge  Float?
  isActive     Boolean    @default(true)
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
  restaurant   Restaurant @relation(fields: [restaurantId], references: [id], onDelete: Cascade)

  @@index([restaurantId], map: "DeliveryRule_restaurantId_fkey")
}

model Order {
  id               Int                  @id @default(autoincrement())
  orderNumber      String               @unique
  userId           Int
  restaurantId     Int
  addressId        Int
  totalAmount      Float
  deliveryCharge   Float
  discount         Float                @default(0)
  finalAmount      Float
  couponId         Int?
  couponCode       String?
  couponDiscount   Float                @default(0)
  status           OrderStatus          @default(PENDING)
  paymentMethod    PaymentMethod
  paymentStatus    PaymentStatus        @default(PENDING)
  transactionId    String?
  paymentGateway   String?
  paymentIntentId  String?
  paidAt           DateTime?
  cancelledByRole  Role?
  cancelReason     String?
  cancelledAt      DateTime?
  refundAmount     Float?
  refundStatus     PaymentStatus?
  refundedAt       DateTime?
  canUserCancel    Boolean              @default(true)
  deliveryBoyId    Int?
  createdAt        DateTime             @default(now())
  updatedAt        DateTime             @updatedAt
  deliveryEarnings DeliveryEarning[]    @relation("OrderDeliveryEarnings")
  address          Address              @relation(fields: [addressId], references: [id])
  coupon           Coupon?              @relation(fields: [couponId], references: [id])
  deliveryBoy      User?                @relation("DeliveryBoyOrders", fields: [deliveryBoyId], references: [id])
  restaurant       Restaurant           @relation(fields: [restaurantId], references: [id])
  user             User                 @relation("CustomerOrders", fields: [userId], references: [id])
  items            OrderItem[]
  statusHistory    OrderStatusHistory[]
  payments         Payment[]            @relation("OrderPayments")

  @@index([userId])
  @@index([restaurantId])
  @@index([deliveryBoyId])
  @@index([status])
  @@index([addressId], map: "Order_addressId_fkey")
  @@index([couponId], map: "Order_couponId_fkey")
}

model OrderItem {
  id             Int             @id @default(autoincrement())
  orderId        Int
  productId      Int
  variantId      Int?
  quantity       Int
  price          Float
  selectedExtras String?         @db.LongText
  order          Order           @relation(fields: [orderId], references: [id])
  product        Product         @relation(fields: [productId], references: [id])
  variant        ProductVariant? @relation(fields: [variantId], references: [id])

  @@index([orderId], map: "OrderItem_orderId_fkey")
  @@index([productId], map: "OrderItem_productId_fkey")
  @@index([variantId], map: "OrderItem_variantId_fkey")
}

model Address {
  id        Int      @id @default(autoincrement())
  userId    Int
  fullName  String
  phone     String
  address   String
  city      String
  state     String
  pincode   String
  latitude  Float
  longitude Float
  isDefault Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  user      User     @relation(fields: [userId], references: [id])
  orders    Order[]

  @@index([userId], map: "Address_userId_fkey")
}

model OrderStatusHistory {
  id            Int         @id @default(autoincrement())
  orderId       Int
  status        OrderStatus
  note          String?
  changedByRole Role
  createdAt     DateTime    @default(now())
  order         Order       @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([orderId])
}

model Payment {
  id               Int                  @id @default(autoincrement())
  referenceType    PaymentReferenceType
  referenceId      Int
  orderId          Int?
  bookingId        Int?
  userId           Int
  amount           Float
  currency         String               @default("INR")
  paymentGateway   String               @default("CASHFREE")
  gatewayOrderId   String?
  transactionId    String?
  paymentSessionId String?
  status           PaymentStatus        @default(PENDING)
  paidAt           DateTime?
  failureReason    String?
  createdAt        DateTime             @default(now())
  updatedAt        DateTime             @updatedAt
  order            Order?               @relation("OrderPayments", fields: [orderId], references: [id])
  user             User                 @relation(fields: [userId], references: [id])

  @@index([referenceType, referenceId])
  @@index([userId])
  @@index([orderId])
}

model DeliveryEarning {
  id            Int      @id @default(autoincrement())
  orderId       Int
  deliveryBoyId Int
  orderAmount   Float
  earningAmount Float
  createdAt     DateTime @default(now())
  deliveryBoy   User     @relation("UserDeliveryEarnings", fields: [deliveryBoyId], references: [id])
  order         Order    @relation("OrderDeliveryEarnings", fields: [orderId], references: [id])

  @@index([deliveryBoyId], map: "DeliveryEarning_deliveryBoyId_fkey")
  @@index([orderId], map: "DeliveryEarning_orderId_fkey")
}

model Featured {
  id        Int      @id @default(autoincrement())
  title     String
  tag       String?
  price     Float?
  image     String?
  active    Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model SpecialOffer {
  id         Int      @id @default(autoincrement())
  title      String
  priceText  String?
  buttonText String?
  buttonLink String?
  image      String?
  active     Boolean  @default(true)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
}

model Page {
  id              Int      @id @default(autoincrement())
  slug            String   @unique
  title           String
  content         String   @db.LongText
  metaTitle       String?
  metaDescription String?  @db.LongText
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

model Newsletter {
  id        Int      @id @default(autoincrement())
  email     String   @unique
  createdAt DateTime @default(now())
}

model WebsiteSetting {
  id            Int      @id @default(autoincrement())
  contactNumber String?
  email         String?
  address       String?
  facebook      String?
  instagram     String?
  twitter       String?
  youtube       String?
  headerLogo    String?
  footerLogo    String?
  footerInfo    String?  @db.Text
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

model ProductVariant {
  id         Int         @id @default(autoincrement())
  name       String
  price      Float
  finalPrice Float
  isActive   Boolean     @default(true)
  productId  Int
  createdAt  DateTime    @default(now())
  updatedAt  DateTime    @updatedAt
  orderItems OrderItem[]
  product    Product     @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([productId])
}

model ProductExtra {
  id        Int      @id @default(autoincrement())
  name      String
  price     Float
  isActive  Boolean  @default(true)
  productId Int
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  product   Product  @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([productId])
}

enum Role {
  ADMIN
  USER
  DELIVERY
}

enum AdvanceType {
  PERCENTAGE
  FLAT
}

enum BookingStatus {
  PENDING
  AWAITING_PAYMENT
  CONFIRMED
  REJECTED
  CANCELLED
}

enum TableLocation {
  INSIDE
  OUTSIDE
}

enum OfferType {
  PERCENTAGE
  FLAT
}

enum CouponType {
  PERCENTAGE
  FLAT
}

enum ChargeType {
  FREE
  FLAT
}

enum OrderStatus {
  PENDING
  CONFIRMED
  PREPARING
  OUT_FOR_DELIVERY
  DELIVERED
  CANCELLED
}

enum PaymentMethod {
  COD
  ONLINE
}

enum PaymentStatus {
  PENDING
  PAID
  FAILED
  REFUNDED
}

enum PaymentReferenceType {
  ORDER
  BOOKING
}
